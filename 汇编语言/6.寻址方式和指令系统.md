# 6.寻址方式和指令系统(80x86)
### 有效地址组成成分
- 位移量: 存放在指令中的 8位、16位、32位的数, 是一个地址;
- 基址: 存放在基址寄存器中的内容, 通常指向首地址;
- 变址: 存放在变址寄存器中的内容, 通常用来访问数组中的某个元素;
- 比例因子: 用于32位机中, 值为 1, 2, 4, 8, 对方问元素长度为 2, 4, 8 字节的数组特别有用;
- 有效地址计算公式: EA = 基址 + (变址 * 比例因子) + 位移量。

## 寻址方式
- 立即寻址方式(Immediate addressing): 操作数直接存放在指令中;
- 寄存器寻址方式(Register addressing): 操作数在寄存器中, 指令指定寄存器号;
- 直接寻址方式(Direct addressing);
- 寄存器间接寻址方式(Register indirect addressing);
- 寄存器相对寻址方式(Register relative addressing);
- 基址变址寻址方式(Based indexed addressing);
- 相对基址变址寻址方式(Relative based indexed addressing)。

### 直接寻址方式
- 有效地址(EA) 就在指令中;
- 必须先求出操作段的物理地址, 然后再访问存储器才能取得操作数。

### 寄存器间接寻址方式
- 操作数的有效地址在基址寄存器或变址寄存器中, 而操作数则在存储器中。

### 寄存器相对寻址方式
- 操作数的有效地址是一个基址或变址寄存器的内容和指令的位移量之和。

### 基址变址寻址方式
- 操作数的有效地址是一个基址寄存器和一个变址寄存器的内容之和, 两个寄存器均由指令指定。

### 相对基址变址寻址方式
- 操作数的有效地址是一个基址寄存器和一个变址寄存器的内容和指令中指定的位移量之和。

## 指令
- MOV(move): 传送;
- PUSH: 进栈;
- POP: 出栈;
- XCHG(Exchange): 交换;
- JMP: 无条件跳转指令;
- WORD PTR: 字操作符;
- WORD PTR: 双字操作符, 转向地址需要取双字;
- FAR PTR: 段间转移操作符;
- IN(Input): 输入;
- OUT(Output): 输出;
- XLAT(Translate): 换码;

### 转移地址有关的寻址方式: 确定转移指令和 CALL指令的转向地址(CPU 如何自动指向下一条指令)
- 段内直接寻址(Intrasegment direct addressing);
- 段内间接寻址(Intrasegment indirect addressing);
- 段间直接寻址(Intersegment direct addressing);
- 段间间接寻址(Intersegment indirect addressing);

#### 段内直接寻址
- 转向有效地址是当前 IP寄存器的内容 + 指令中指定的 8位或16位 位移量之和;

#### 段内间接寻址方式
- 转向有效地址是一个寄存器或一个存储单元的内容;
- 根据数据的寻址方式计算出 EA值。
```
JMP BX;
JMP WORD PTR [TABLE + BP];

/*
* 计算物理地址: 需要 SS(段寄存器), TABLE, BP
* 假设 SS = 2000, TABLE = 1000, BP = 3000
* 求物理地址, 字类型占两个存储单元
*/
20000 + 1000 + 3000 = 24000H
                      24001H
// 将求得的转移的有效地址发送到 IP 寄存器, 实现指令的跳转
// 下面的 EA 即为转移的有效地址
物理地址 = 16D * (CS) + EA
```

#### 段间直接寻址
- 指令中直接提供转向段地址和偏移地址;
- 用指令中指定的偏移地址取代 IP寄存器的内容, 用指令中指定的短地址取代 CS寄存器的内容, 即可完成从一个段到另一个段的转移操作。

### MOV 指令的 7种格式
- 格式: MOV 目的操作数地址, 源操作数地址;
- mem: 存储器;
- reg: 寄存器;
- segreg: 段寄存器;

#### 1. MOV mem/reg1, mem/reg2
- 可以同时指定两个寄存器, 但不能同时指定两个存储单元。

#### 2. MOV reg, data
- data: 立即数;
- reg 不允许指向段寄存器。

#### 3. MOV ac, mem
- ac: 累加器, 字节操作时使用 AL寄存器, 字操作时使用 AX寄存器;

#### 4. MOV mem, ac

#### 5. MOV segreg, mem/reg
- segreg: 段寄存器, 但不允许使用 CS寄存器;
- 这条指令执行完后不响应中断, 要等下一条指令执行完后才能响应中断;
- 常用于初始化程序, 指定堆栈及数据信息的段地址;
#### 6. MOV mem/reg, segreg

#### 7. MOV mem/reg, data
- 目的操作数只用存储器寻址方式而不用寄存器方式;
- 常用于变量的初始化;

### PUSH 进栈操作
- SP 始终指向当前栈顶。
- PUSH SRC;
- 堆栈先空出两个存储单元(SP 上移), 然后让数据进来;  
    SP ⬅ (SP) - 2
    ((SP) + 1, (SP)) ⬅ (SRC);

### POP 出栈操作
- POP DST;
- 堆栈先弹出内容, 然后 SP 下移;  
- 不允许使用立即数的方式。

### XCHG 交换指令
- XCHG OPR1, OPR2;
- (OPR1) <-> (OPR2);
- 目的数不允许使用立即数的方式。

### IN: 从 I/O 到 CPU 的信息传送
- CPU 只能使用累加器(AL, AX, EAX) 接收或发送信息。
#### 长格式(端口号 0~256)
- IN AL, PORT (字节);
- IN AX, PORT (字);
- IN EAX, PORT (双字);

#### 短格式(端口号大于 256)
- 端口号存储在 DX 中, 从 DX 的端口号的地址中获取一个 字/字节 的数据;
- IN AL, DX (字节);
- IN AX, DX (字);
- IN EAX, DX (双字);

### OUT: 从 CPU 到 I/O 的信息传送
#### 长格式(端口号 0~256)
- OUT PORT, AL (字节);
- OUT PORT, AX (字);
- OUT PORT, EAX (双字);
