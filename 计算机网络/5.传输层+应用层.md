# 5.传输层+应用层
## 传输层
- TCP 协议
- UDP 协议
- 协议: 约定传输的数据第几位代表什么含义;
- 报文首部包含 源IP地址、目的IP地址, 源端口、目的端口;

### TCP协议
- 数据分段、编号;
- 可靠传输(丢包重传);
- 流量控制;
- 避免网络拥塞;
- 建立会话, 每条 TCP连接只能有两个端点, 每条 TCP连接只能点对点(一对一);
- eg: 上网、视频传输;

#### 报文段首部(20个字节)
- 源端口、目标端口;
- 序号: 本数据段的第一个字节是整个文件的第几个字节;
- 确认号: 对方下一个数据包应该发送第几个字节的数据包;
- 数据偏移: 数据是从包的哪里开始;

#### 可靠传输
- TCP 发送端和接收端各有一个缓存区;
- 发送端先将数据传输到缓存区, 然后从缓存区切片发送;
- 发送端通过滑动发送窗口确定要从缓存区发送的数据;
- 接收端先将数据接收到缓存区, 收到后向发送端传递消息;
- 发送端收到消息后将发送窗口后移, 并将已传输的数据从缓存区删除;
- 如果丢包, 接收端传输消息, 将丢失的部分重传。

##### 停止等待协议
- TCP 发送一个包后就停止, 等待确认, 确认后再发送第二个包;
- 重传是自动进行的, 发送方只要没有收到确认就会重传;
- 超时重传的时间是根据之前传输的平均 往返时间(RTT) 计时;
- 缺点: 信道利用率太低;

##### 流水线传输
- 不再每发一个包就等待确认, 而是一次性发送5个包;
- 维持一个滑动窗口, 一个包确认完毕后, 窗口向后滑动一位;

#### 流量控制 
- 根据发送端和接收端缓冲区大小进行控制;
- 缓存区满了就停止传输;

#### TCP 阻塞控制
- 是一种全局的控制;
- 发送端维持拥塞窗口(cwnd);
- 第一轮发送 1个请求, 维护 1个 cwnd, 如果成功就进行第二轮;
- 第二轮发送 2个请求, 维护 2个 cwnd, 如果成功就进行第三轮;
- 第三轮发送 4个请求, 维护 4个 cwnd, 如果成功就进行第四轮;
- 第四轮发送 8个请求, 维护 8个 cwnd 。。。;
- 慢增长门限初始值为 16, 即: 当 cwnd 增长到 16 时, 每一轮增加 1个 cwnd;
- 如果网络拥塞(即: 出现丢包现象), cwnd 重置为 1, 并记录下一次慢增长门限为上次丢包时的 1/2;
- TCP 传输数量先指数型增长后线性增长;
- 发送窗口上限值由接收端同时最多能接受数据条数(rwnd) 和 cwnd 共同决定: Min(rwnd, cwnd);

#### TCP 连接管理
- 建立连接: 3次握手(如果是2次握手, 会导致接收端等待);
- 释放连接: 4次挥手;

### UDP协议
- 不建立会话, 一个数据包就能完成数据通信;
- eg: QQ聊天、计算机上课时的多播、DNS 解析;

## 应用层
### 传输层和应用层之间的关系: TCP/UDP + 一个端口
- HTTP协议 = TCP协议 + 80端口;
- HTTPS协议 = TCP协议 + 443端口;
- ftp协议 = TCP协议 + 21端口;
- SMTP协议(发电子邮件) = TCP协议 + 25端口;
- POP3协议(收电子邮件) = TCP协议 + 110端口;
- RDP协议(远程桌面) = TCP协议 + 3389端口;
- 共享文件夹 = TCP协议 + 45端口;
- SQL = TCP协议 + 1433端口;
- DNS = UDP协议 + 53端口 或者 TCP协议 + 53端口;

### 应用层和外部服务之间的关系
- 服务运行后在 TCP 或 UDP 的某个端口监听客户端请求;
- 通过 IP 定位计算机;
- 通过端口定位服务;
- 端口代表服务;

### DNS 服务
- DNS 负责将域名解析成IP;
- 私人 DNS服务器;

### DHCP 动态主机配置协议
- DHCP 服务器必须是静态地址;

### FTP(File Transfer Protocol) 文件传输协议
- 控制连接: FTP服务器 和 FTP客户端 使用 TCP协议 的 21端口;
- 数据传输: 主动模式、被动模式;
- 主动模式: 服务端使用 20端口;
- 被动模式: 服务端使用指定范围内的某个端口; 
- FTP服务器如果有防火墙, 开启 20 和 21端口, 采用主动模式;

### HTTP 超文本传输协议
- 同一台服务器可以通过 设置不同的IP 或者 同一个IP使用不同的域名通过 80端口 访问不同的网站;

#### web 代理服务器
- 可以缓存网页, 节省内网访问 Internet 的带宽;
- 通过代理服务器绕过长城防火墙;
- 