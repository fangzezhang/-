# 4.网络层

### IP地址
- IP-v4 32位: 网络号(net-id)字段 + 主机号(host-id)字段;
- 主机号部分不能全为0(代表网段), 也不能全为1(代表广播, 网络中所有计算机都能收到这个数据包);
- 根据网络号字段区分 A、B、C 类地址;

#### A、B、C 类地址区分
- IPV4 前8位共有 2^8 个: 0~255;
- A类(前8位二进制: 0...): 0~126(127 为本机地址) + 24位 host-id;
- B类(前8位二进制: 10...): 128~191 + 16位 host-id;
- C类(前8位二进制: 110...): 192~223 + 8位 host-id;
- D类(前8位二进制: 1110...):224~240;

### 子网掩码
- 作用: 和 IP地址 做 与运算, 获得网络号(net-id);
- 与 IP 做二进制与运算, 判断两台计算机是否在一个网段, 如果在一个网段则直接发起请求, 否则通过网关发起请求到目标地址;
```
IP: 		  172.16.122.204
子网掩码: 255.255.0.0
做二进制与运算得到网络号: 172.16.0.0, 主机位归零 
```

### 子网划分
- 子网也可以分成多个网段;
- 遵循除2的原则;

### 超网
- 将多个网段合并成一个;
- 通过设置子网掩码实现;
```
/*
* 一个C类地址, 网段最多 255 个地址, 此时需要将 400台机器设置成一个网段
*/
-- 将 192.168.0.0 和 192.168.0.1 合并
子网掩码: 255.255.254.0
对应二进制: 11111111 11111111 11111110 00000000  
和 IP 做与运算得到网络号, 将两个网段合并到 192.168.0.0 网段
```

### MAC地址 VS IP
- IP 决定数据包终点;
- MAC 决定了数据包的下一个目标;

### ARP 协议
- 通过广播将IP地址解析成MAC地址;
- 同一台交换机下, 一台计算机和某台计算机进行通讯之前需要知道对方的 MAC地址;  
- 方法是发起广播, 对方接收后返回 MAC地址;
- arp -a: 获取网关 MAC地址;
- arp -s IP MAC: 修改网关MAC地址;

#### ARP 欺骗
- 交换机的作用是 A、B两台计算机间直接信息传递;
- 攻击者 C 在 A 广播时也将自己的 MAC地址返回;
- 攻击者C 就会截获 A 和 B 的通讯数据。
- 可以控制其他计算机带宽: 攻击者覆盖网关 MAC地址,  
		局域网请求外部流量需要通过网关, 此时网关 MAC地址被覆盖, 攻击者可以控制其他计算机的流量。
- 可以截获密码。
- 解决方法: 清除缓存、使用 ARP防火墙;

### IP协议的数据包
- IP数据包组成: 首部(20个字节) + 数据;
- 1个字节 8个比特位;

#### 数据包首部固定部分
- 版本: 4位, IP协议的版本(IPV4, IPV6);
- 首部长度: 4位;
- 区分服务: 8位, 告诉网络中传递的数据的优先级;
- 总长度: 8位, 首部 + 数据部分总共大小;
- 标识: 16位, 表示数据包的标识, 每产生一个数据包就加1;
- 标志: 3位, 表示数据包是否分片, 最低位为 MF(More Fragment), MF=1 表示后面还有分片, MF=0 表示最后一个分片;
- 片偏移: 13位, 数据包大小超过 1500个字节时, 需要分片传输, 这里记录片的偏移量大小(字节/8);
- 生存时间: 8位, TTL, 数据包传输中每过一个路由器 TTL-1, 为 0 时舍弃数据包,  
		可以通过 ping IP -i 1 来追踪数据包下一个传输路径, ping IP -i 2 追踪第二个传输路径;
- 协议: 8位, 表示携带的数据使用哪种协议(ICMP、IGMP、TCP、UDP), 以便目的主机 IP层将数据上交给哪个处理过程;
- 首部校验和: 16位, 检验首部是否错误;
- 源地址: 32位, IP地址;
- 目的地址: 32位, IP地址;

### ICMP 协议
- IP 层协议, 为了提高 IP数据交付成功的机会, 查看网络是否故障;
- 允许主机或路由器报告差错情况和有关异常报告;
- 应用实例: ping 命令、pathping;

### VPN(Virtual Private Network) 虚拟专用网络
- 10 开头的网段为企业、学校预留网段, 私网, 外部无法直接访问内部地址;
- VPN 实现在互联网上向私网传递数据。
- 通过拨号登陆, VPN 对外网用户赋予一个内网IP, 外网就可以访问内网;
- 使用 VPN 相当于将外部计算机搬到内网, 外部计算机访问互联网的流量会先经过内网, 然后再访问外部网络;
- 可以通过取消勾选 "在远程网路上使用默认网关" 来实现连接 VPN 时不通过内网访问外网;

### IGMP 协议: 组播、多播

### 端口映射